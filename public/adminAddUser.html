<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–æ–¥–∞—Ç–∏ —É—Ä–æ–∫</title>

  <link rel="stylesheet" href="css/fonStyles.css">    
  <link rel="stylesheet" href="css/adminAddUser.css">
  <link rel="stylesheet" href="css/navStyles.css">
  <link rel="stylesheet" href="css/navStylesAdmin.css">

</head>
<body>
  <header>
    <div class="logo">AI-–∫—É—Ä—Å –∑ –Ω—É–ª—è</div>
  
    <nav class="nav-links-admin">
      <div class="nav-left">
        <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="lessons.html">–£—Ä–æ–∫–∏</a>
        <a href="homework.html" id="homeworkLink">–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</a>
      </div>
  
      <div class="nav-right">
        <a href="admin.html" class="admin-link" style="color: #58a6ff;">–î–æ–¥–∞—Ç–∏ —É—Ä–æ–∫</a>
        <a href="adminHomework.html" class="admin-link"style="color: #58a6ff;">–î–æ–º–∞—à–Ω—ñ —Ä–æ–±–æ—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</a>
        <a href="adminAddUser.html" class="admin-link active"style="color: #58a6ff;">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</a>
      </div>
    </nav>

    <select id="mobileNav" class="mobile-nav">
      <option value="index.html">–ì–æ–ª–æ–≤–Ω–∞</option>
      <option value="lessons.html">–£—Ä–æ–∫–∏</option>
      <option value="homework.html">–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</option>
      <option value="admin.html" style="color: #58a6ff;">–î–æ–¥–∞—Ç–∏ —É—Ä–æ–∫</option>
      <option value="adminHomework.html" style="color: #58a6ff;">–î–æ–º–∞—à–Ω—ñ —Ä–æ–±–æ—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</option>
      <option value="adminAddUser.html" style="color: #58a6ff;">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</option>
    </select>
    
  </header>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
<div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeRegisterModal()">&times;</span>
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
      <div id="registerError" class="error"></div>
      
      <input type="text" id="regName" placeholder="–Ü–º'—è" required />
      <input type="email" id="regEmail" placeholder="Email" required />
            
      <div class="password-wrapper">
        <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <span class="toggle-password" onclick="togglePassword('regPassword')">üëÅÔ∏è</span>
      </div>
  
      <div class="password-wrapper">
        <input type="password" id="regConfirm" placeholder="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä–æ–ª—å" required />
        <span class="toggle-password" onclick="togglePassword('regConfirm')">üëÅÔ∏è</span>
      </div>
  
      <div class="custom-file">
        <input type="file" id="regPhoto" accept="image/*" style="display:none; " onchange="updateFileName()" />
        <button type="button" onclick="document.getElementById('regPhoto').click()" id="fileBtn">–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª</button>
        <span id="fileName">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
      </div>
      <button onclick="handleRegister()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è -->
<div id="editUserModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
    <div id="editError" class="error"></div>

    <input type="text" id="editName" placeholder="–Ü–º º—è" />
    <input type="email" id="editEmail" placeholder="Email" />

    <div class="password-wrapper">
      <input type="password" id="editPassword" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å (–Ω–µ –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)" />
      <span class="toggle-password" onclick="togglePassword('editPassword')">üëÅÔ∏è</span>
    </div>

    <div class="custom-file">
      <input type="file" id="editPhoto" accept="image/*" style="display:none;" onchange="updateEditFileName()" />
      <button type="button" onclick="document.getElementById('editPhoto').click()" id="editFileBtn">–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ</button>
      <span id="editFileName">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
    </div>

    <button onclick="saveUserEdit()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
  </div>
</div>

  <div id="usersListContainer">
    <h3>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤ –±–∞–∑—ñ:</h3>
    <ul id="usersList"></ul>

    <button onclick="openRegisterModal()" id="registerLink">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è -->
<div id="confirmModal" class="custom-modal hidden">
  <div class="custom-modal-content">
    <p id="confirmMessage"></p>
    <div class="modal-buttons">
      <button id="confirmYes">‚úÖ –¢–∞–∫</button>
      <button id="confirmNo">‚ùå –ù—ñ</button>
    </div>
  </div>
</div>

  <div id="toastContainer" style="
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
display: flex;
flex-direction: column;
gap: 10px;
z-index: 9999;
align-items: center;
"></div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    
    // ======= –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ó–ê–ü–ò–¢–Ü–í =======
    async function apiRequest(endpoint, method = 'GET', data = null, isFormData = false) {
      const options = { method };
      
      if (data) {
        if (isFormData) {
          options.body = data;
        } else {
          options.headers = { 'Content-Type': 'application/json' };
          options.body = JSON.stringify(data);
        }
      }
    
      const res = await fetch(API_URL + endpoint, options);
      if (!res.ok) throw new Error(`–ü–æ–º–∏–ª–∫–∞ ${res.status}`);
      return await res.json();
    }
    
    function showError(msg, el = 'errorMsg') {
      document.getElementById(el).textContent = msg;
    }
    
    // ======= –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û =======
    function openRegisterModal() {
      document.getElementById('registerModal').style.display = 'block';
    }
    function closeRegisterModal() {
      document.getElementById('registerModal').style.display = 'none';
    }
    window.onclick = function(event) {
      if (event.target == document.getElementById('registerModal')) closeRegisterModal();
    };
    
    // ======= –û–ù–û–í–õ–ï–ù–ù–Ø –°–ü–ò–°–ö–£ –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í =======
    async function fetchUsers() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:3000/api/users', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ ' + response.status);

    const users = await response.json();
    console.log('–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:', users);

const usersList = document.getElementById('usersList');
usersList.innerHTML = users.map(u => `
  <li class="user">
    <div class="user-info">
      <img src="${u.avatarUrl || 'img/default-avatar.png'}" alt="avatar">
      <div>
        <span>${u.name}</span><br>
        <span class="user-email">${u.email}</span>
      </div>
    </div>
    <div class="user-actions">
      <button class="edit-btn" onclick="openEditModal('${u._id}', '${u.name}', '${u.email}')">‚úèÔ∏è</button>
      <button class="delete-btn" onclick="deleteUser('${u._id}')">üóëÔ∏è</button>
    </div>
  </li>
`).join('');

  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:', err);
  }
}

async function deleteUser(id) {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;

  const token = localStorage.getItem('token');
  await fetch(`${API_URL}/users/${id}`, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  fetchUsers();
}

let currentUserId = null;

// –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
function openEditModal(id, name, email) {
  currentUserId = id;
  document.getElementById('editName').value = name || '';
  document.getElementById('editEmail').value = email || '';
  document.getElementById('editPassword').value = '';
  document.getElementById('editFileName').textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
  document.getElementById('editUserModal').style.display = 'block';
}

// –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
function closeEditModal() {
  document.getElementById('editUserModal').style.display = 'none';
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ
function updateEditFileName() {
  const input = document.getElementById('editPhoto');
  const fileName = input.files[0] ? input.files[0].name : '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
  document.getElementById('editFileName').textContent = fileName;
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω
async function saveUserEdit() {
  const name = document.getElementById('editName').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const password = document.getElementById('editPassword').value;
  const photo = document.getElementById('editPhoto').files[0];

  const formData = new FormData();
  if (name) formData.append('name', name);
  if (email) formData.append('email', email);
  if (password) formData.append('password', password);
  if (photo) formData.append('photo', photo);

  const token = localStorage.getItem('token');

  try {
    const res = await fetch(`${API_URL}/users/${currentUserId}`, {
      method: 'PUT',
      body: formData,
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');

    showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    closeEditModal();
    fetchUsers();
  } catch (err) {
    document.getElementById('editError').textContent = err.message;
  }
}


    
    // ======= –û–ù–û–í–õ–ï–ù–ù–Ø –Ü–ú–ï–ù–Ü –§–ê–ô–õ–£ =======
    function updateFileName() {
      const input = document.getElementById('regPhoto');
      const fileName = input.files[0] ? input.files[0].name : '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
      document.getElementById('fileName').textContent = fileName;
    }
    
    // ======= –ü–û–ö–ê–ó / –ü–†–ò–•–û–í–ê–ù–ù–Ø –ü–ê–†–û–õ–Æ =======
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }
    
    // ======= –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê =======
    async function handleRegister() {
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const password = regPassword.value;
      const confirm = regConfirm.value;
      const photo = regPhoto.files[0];
    
      if (!name || !email || !password || !confirm)
        return showError('–í—Å—ñ –ø–æ–ª—è –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ', 'registerError');
    
      if (password !== confirm)
        return showError('–ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å', 'registerError');
    
      const formData = new FormData();
      formData.append('name', name);
      formData.append('email', email);
      formData.append('password', password);
      if (photo) formData.append('photo', photo);
    
      try {
        await apiRequest('/register', 'POST', formData, true);
        showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ!');
        closeRegisterModal();
        fetchUsers();
      } catch (e) {
        showError(e.message, 'registerError');
      }
    }
      window.addEventListener('DOMContentLoaded', () => {
      fetchUsers();
    });

    function showToast(message, type = 'info', duration = 4000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');

  let bgColor = '#21262d';
  if (type === 'success') bgColor = '#238636';
  else if (type === 'error') bgColor = '#f85149';
  else if (type === 'warning') bgColor = '#e3b341';

  toast.style.background = bgColor;
  toast.style.color = '#c9d1d9';
  toast.style.padding = '10px 15px';
  toast.style.borderRadius = '6px';
  toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
  toast.style.fontSize = '14px';
  toast.style.fontWeight = '500';
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  toast.textContent = message;
  toast.style.whiteSpace = 'nowrap'; 

  container.appendChild(toast);

  // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  }, 10);

  // –ê–≤—Ç–æ-–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px)';
    setTimeout(() => container.removeChild(toast), 300);
  }, duration);
}


let userToDeleteId = null; // –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–≥–æ —Ö–æ—á–µ–º–æ –≤–∏–¥–∞–ª–∏—Ç–∏

function deleteUser(id) {
  userToDeleteId = id;
  const confirmModal = document.getElementById('confirmModal');
  const confirmMessage = document.getElementById('confirmMessage');

  confirmMessage.textContent = '–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?';
  confirmModal.classList.remove('hidden');

  // –ö–Ω–æ–ø–∫–∏ –¢–∞–∫ / –ù—ñ
  const yesBtn = document.getElementById('confirmYes');
  const noBtn = document.getElementById('confirmNo');

  // –û—á–∏—Å—Ç–∏–º–æ —Å—Ç–∞—Ä—ñ —Å–ª—É—Ö–∞—á—ñ, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞–ª–∏—Å—è
  yesBtn.onclick = async () => {
    confirmModal.classList.add('hidden');
    await confirmDeleteUser();
  };

  noBtn.onclick = () => {
    confirmModal.classList.add('hidden');
    userToDeleteId = null;
  };
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
async function confirmDeleteUser() {
  if (!userToDeleteId) return;

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_URL}/users/${userToDeleteId}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');

    showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
    fetchUsers();
  } catch (err) {
    showToast(err.message, 'error');
  } finally {
    userToDeleteId = null;
  }
}

const mobileNav = document.getElementById('mobileNav');

// —à—É–∫–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å–µ—Ä–µ–¥ –æ–±–æ—Ö —Ç–∏–ø—ñ–≤ –º–µ–Ω—é
const activeLink =
  document.querySelector('.nav-links a.active') ||
  document.querySelector('.nav-links-admin a.active');

if (activeLink) {
  mobileNav.value = activeLink.getAttribute('href');
}

// –ø—Ä–∏ –∑–º—ñ–Ω—ñ select –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
mobileNav.addEventListener('change', (e) => {
  window.location.href = e.target.value;
});

</script>
    
</body>
</html>