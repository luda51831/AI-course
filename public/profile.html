<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</title>
  <link rel="stylesheet" href="css/fonStyles.css">    
  <link rel="stylesheet" href="css/profileStyles.css">
  <link rel="stylesheet" href="css/navStyles.css">

</head>
<body>
  <header>
    <div class="logo">
      <span class="logo-text">AI-–∫—É—Ä—Å –∑ –Ω—É–ª—è</span>
      <img src="logo.png" alt="Logo" class="logo-img">
    </div>

    <nav class="nav-links">
      <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="lessons.html">–£—Ä–æ–∫–∏</a>
      <a href="homework.html" id="homeworkLink">–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</a>
      <a href="#" id="profileLink" class="active">–ü—Ä–æ—Ñ—ñ–ª—å</a>
    </nav>

    <select id="mobileNav" class="mobile-nav">
      <option value="index.html">–ì–æ–ª–æ–≤–Ω–∞</option>
      <option value="lessons.html">–£—Ä–æ–∫–∏</option>
      <option value="homework.html">–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</option>
      <option value="#" id="profileLink">–ü—Ä–æ—Ñ—ñ–ª—å</option>
    </select>

    <div class="user-info">
    <select id="languageSelect">
      <option value="uk">üá∫üá¶</option>
      <option value="en">üá¨üáß</option>
    </select>
  </div>

  <div class="notification" id="notificationIcon" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
    <img src="../alarm-bell.png" alt="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" class="notification-img">
    <span class="badge hidden" id="notificationCount">0</span>
  </div>
    <div id="notificationList" style="display:none; max-width: 400px; position: absolute; top: 50px; right: 20px; background: #161b22; color: #c9d1d9; border: 1px solid #58a6ff; border-radius: 8px; padding: 10px;"></div>
              
  </header>

  <div class="profile-container">

    <div class="profile-details">
      <img id="avatar" class="avatar" src="" alt="–§–æ—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" />
      <h1 id="username">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
      <div class="email" id="email"></div>
      <div id="currentLanguage" style="margin-top:10px; color:#8b949e;"></div>
      <div id="progressUk"></div>
<div id="progressEn"></div>

      <button class="logout" id="logoutBtn">–í–∏–π—Ç–∏</button>
    </div>

    <div class="lesson-info">
      <div class="homework-list">
        <h2>–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
        <div id="homeworkContainer">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–º–∞—à–Ω—ñ—Ö –∑–∞–≤–¥–∞–Ω—å...</div>
      </div>
    </div>

  </div>
  
  <script>
    
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');

    if (!token) {
      alert('–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!');
      window.location.href = '/';
    }

// –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –ø—É–Ω–∫—Ç –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
const mobileNav = document.getElementById('mobileNav');
const activeLink = document.querySelector('.nav-links a.active');
if (activeLink) {
  mobileNav.value = activeLink.getAttribute('href');
}


if (mobileNav) {
  mobileNav.addEventListener('change', (e) => {
    const value = e.target.value;
    const role = localStorage.getItem('role'); // –±–µ—Ä–µ–º–æ —Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

    if (value === '#') { // —Ü–µ —Ç–≤—ñ–π –ø—É–Ω–∫—Ç "–ü—Ä–æ—Ñ—ñ–ª—å"
      if (role === 'admin') {
        window.location.href = 'admin.html';
      } else {
        window.location.href = 'profile.html';
      }
    } else {
      window.location.href = value;
    }
  });
}

// –ø—Ä–∏ –∑–º—ñ–Ω—ñ select –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
mobileNav.addEventListener('change', (e) => {
  window.location.href = e.target.value;
});

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  async function loadProfile() {
  try {
    const res = await fetch(API_URL + '/profile', {
      headers: { Authorization: 'Bearer ' + token }
    });

    if (!res.ok) {
      alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é');
      localStorage.removeItem('token');
      window.location.href = '/';
      return;
    }

    const data = await res.json();

    document.getElementById('username').textContent = data.name;
    document.getElementById('email').textContent = data.email;
    document.getElementById('avatar').src = data.avatarUrl;

    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –º–æ–≤—É
    const langSelect = document.getElementById('languageSelect');
    const currentLangDiv = document.getElementById('currentLanguage');
    const currentLang = langSelect.value || 'uk';

    currentLangDiv.textContent = currentLang === 'uk' ? '–ü–æ—Ç–æ—á–Ω–∞ –º–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' : 'Current language: English';

    langSelect.addEventListener('change', () => {
      const newLang = langSelect.value;
      currentLangDiv.textContent = newLang === 'uk' ? '–ü–æ—Ç–æ—á–Ω–∞ –º–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' : 'Current language: English';

      loadProgressSummary();
      loadHomework();
    });

    await loadProgressSummary();
  } catch (err) {
    alert('–ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è');
    console.error(err);
  }
}


    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å
  async function loadProgressSummary() {
  try {
    const res = await fetch(API_URL + '/profile/progress', {
      headers: { Authorization: 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('HTTP error ' + res.status);

    const data = await res.json();
    console.log('–ü—Ä–æ–≥—Ä–µ—Å:', data);

    const lang = document.getElementById("languageSelect").value;
    const containerUk = document.getElementById('progressUk');
    const containerEn = document.getElementById('progressEn');

    // –û—á–∏—â–∞—î–º–æ –æ–±–∏–¥–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
    containerUk.innerHTML = '';
    containerEn.innerHTML = '';

    if (lang === "uk") {
      containerUk.innerHTML = `
        <div style="margin-top:10px; background:#21262d; padding:10px; border-radius:6px;">
          <strong>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–∞:</strong> ${data.uk.overallProgress}% (${data.uk.totalLessons} —É—Ä–æ–∫—ñ–≤)
        </div>
      `;
    } else if (lang === "en") {
      containerEn.innerHTML = `
        <div style="margin-top:10px; background:#21262d; padding:10px; border-radius:6px;">
          <strong>English program:</strong> ${data.en.overallProgress}% (${data.en.totalLessons} lessons)
        </div>
      `;
    }

  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É:', err);
  }
}


async function downloadHomework(id, filename) {
  const token = localStorage.getItem('token');
  const res = await fetch(`/download/homework/${id}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É');

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
}


    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    async function loadHomework() {
      try {
        const res = await fetch(API_URL + '/homework', {
          headers: { Authorization: 'Bearer ' + token }
        });

        if (!res.ok) {
          document.getElementById('homeworkContainer').textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è';
          return;
        }

        const homeworks = await res.json();

        if (homeworks.length === 0) {
          document.getElementById('homeworkContainer').textContent = '–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ';
          return;
        }

        // –°–æ—Ä—Ç—É—î–º–æ –¥–æ–º–∞—à–∫–∏ –∑–∞ –¥–∞—Ç–æ—é (–Ω–æ–≤—ñ –∑–≤–µ—Ä—Ö—É)
        homeworks.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

        const container = document.getElementById('homeworkContainer');
        container.innerHTML = '';

        homeworks.forEach(hw => {
  const div = document.createElement('div');
  div.className = 'homework-item';

  const lessonNum = document.createElement('div');
lessonNum.className = 'lesson-number';

// –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∏–±—Ä–∞–Ω—É –º–æ–≤—É –∑ select
const lang = document.getElementById("languageSelect").value;

if (lang === "uk") {
  lessonNum.textContent = `–£—Ä–æ–∫ ${hw.lessonNumber}`;
} else if (lang === "en") {
  lessonNum.textContent = `Lesson ${hw.lessonNumber}`;
}

document.getElementById("languageSelect").addEventListener("change", () => {
  loadHomework(); 
  loadProgressSummary(); 
});


  const filename = document.createElement('a');
  filename.className = 'homework-filename';

filename.style.cursor = 'pointer';
filename.addEventListener('click', () => downloadHomework(hw._id, hw.filename));

filename.target = '_blank';
filename.textContent = hw.filename || hw.storedFilename || '–§–∞–π–ª';

  filename.textContent = hw.filename || '–§–∞–π–ª –±–µ–∑ –Ω–∞–∑–≤–∏';
  filename.style.color = '#58a6ff';
  filename.style.textDecoration = 'none';

  const dateDiv = document.createElement('div');
dateDiv.className = 'homework-date';

const date = new Date(hw.uploadedAt);
const locale = lang === "uk" ? "uk-UA" : "en-US";

const formattedDate = date.toLocaleString(locale, { 
  year: "numeric", 
  month: "short", 
  day: "numeric", 

});

// –¥–∞—Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
const deleteDate = new Date(date.getTime() + 37 * 24 * 60 * 60 * 1000);
const formattedDeleteDate = deleteDate.toLocaleDateString(locale, {
  year: "numeric",
  month: "short",
  day: "numeric"
});

// —Ä—ñ–∑–Ω–∏—Ü—è —É –¥–Ω—è—Ö
const daysLeft = Math.ceil((deleteDate - new Date()) / (1000 * 60 * 60 * 24));

// –≤–∏–±—ñ—Ä –∫–æ–ª—å–æ—Ä—É
let color;
if (daysLeft <= 5) color = "#f85149"; 
else if (daysLeft <= 14) color = "#e3b341";
else color = "#3fb950"; 

// —Ç–µ–∫—Å—Ç –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –º–æ–≤–∏
const text = lang === "uk"
  ? `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${formattedDate} ‚Äî –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ <span style="color:${color}; font-weight:600;">${daysLeft} –¥–Ω.</span> (${formattedDeleteDate})`
  : `Uploaded: ${formattedDate} ‚Äî will be deleted in <span style="color:${color}; font-weight:600;">${daysLeft} days</span> (${formattedDeleteDate})`;

dateDiv.innerHTML = text;
dateDiv.style.fontSize = "0.52em";
dateDiv.style.color = "#8b949e";



  div.appendChild(lessonNum);
  div.appendChild(filename);
  div.appendChild(dateDiv);

  container.appendChild(div);
});

      } catch (err) {
        document.getElementById('homeworkContainer').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–º–∞—à–Ω—ñ—Ö –∑–∞–≤–¥–∞–Ω—å';
        console.error(err);
      }
    }

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('token');
      window.location.href = '/';
    };

    loadProfile();
    loadHomework();

    
  </script>
  
  <script src="language.js"></script>
  <script src="index.js"></script>
   <script src="notification.js"></script>

</body>
</html>
